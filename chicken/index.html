<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chicken Disease Classification</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #4CAF50; margin-bottom: 20px; }
        .upload-section { margin-bottom: 20px; padding: 20px; border: 2px dashed #ddd; border-radius: 8px; text-align: center; }
        .btn { background: #4CAF50; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin: 10px; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .progress { margin: 20px 0; }
        .progress-bar { width: 100%; height: 20px; background: #e0e0e0; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: #4CAF50; transition: width 0.3s; }
        .results { margin-top: 20px; }
        .message { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .message.info { background: #e3f2fd; }
        .message.success { background: #e8f5e8; }
        .message.error { background: #ffebee; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
        th { background: #f5f5f5; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üêî Chicken Disease Classification</h1>
        
        <div id="message" class="message"></div>
        
        <div class="upload-section">
            <h3>Upload CSV File</h3>
            <p>CSV format: image_url,disease_name</p>
            <input type="file" id="csvFile" accept=".csv">
            <button class="btn" id="trainBtn" disabled>Start Training</button>
        </div>

        <div id="trainingSection" style="display: none;">
            <h3>Training Progress</h3>
            <div class="progress">
                <div class="progress-bar">
                    <div id="epochProgress" class="progress-fill" style="width: 0%"></div>
                </div>
                <div>Loss: <span id="currentLoss">-</span> | Accuracy: <span id="currentAccuracy">-</span>%</div>
            </div>
        </div>

        <div id="resultsSection" class="results" style="display: none;">
            <h3>Results</h3>
            <div id="diseaseRanking"></div>
            <div id="samplePredictions"></div>
        </div>
    </div>

    <script type="module">
        import DataLoader from './data-loader.js';
        import CNNModel from './cnn.js';

        class ChickenDiseaseApp {
            constructor() {
                this.dataLoader = new DataLoader();
                this.model = null;
                this.currentData = null;
                this.initializeEventListeners();
            }

            initializeEventListeners() {
                document.getElementById('csvFile').addEventListener('change', (e) => {
                    document.getElementById('trainBtn').disabled = !e.target.files[0];
                });
                
                document.getElementById('trainBtn').addEventListener('click', () => this.startTraining());
            }

            async startTraining() {
                const csvFile = document.getElementById('csvFile').files[0];
                if (!csvFile) {
                    this.showMessage('Please select a CSV file', 'error');
                    return;
                }

                try {
                    this.showMessage('Loading dataset from CSV...', 'info');
                    document.getElementById('trainingSection').style.display = 'block';
                    document.getElementById('trainBtn').disabled = true;

                    // Load data from CSV
                    this.currentData = await this.dataLoader.loadFromCSV(csvFile);
                    
                    this.showMessage(`Loaded ${this.currentData.labelMap.size} disease classes`, 'success');

                    // Create and train model
                    this.model = new CNNModel(this.currentData.labelMap.size);
                    this.model.createModel();
                    
                    await this.model.train(
                        this.currentData.X_train, 
                        this.currentData.y_train,
                        this.currentData.X_test,
                        this.currentData.y_test,
                        15,
                        {
                            onEpochEnd: (epoch, logs) => {
                                this.updateTrainingProgress(epoch, logs);
                            }
                        }
                    );

                    // Evaluate model
                    const metrics = await this.model.computeMetrics(
                        this.currentData.X_test, 
                        this.currentData.y_test,
                        this.currentData.reverseLabelMap
                    );
                    
                    this.displayResults(metrics);
                    document.getElementById('resultsSection').style.display = 'block';

                } catch (error) {
                    this.showMessage('Error: ' + error.message, 'error');
                    console.error(error);
                }
            }

            updateTrainingProgress(epoch, logs) {
                document.getElementById('currentLoss').textContent = logs.loss.toFixed(4);
                document.getElementById('currentAccuracy').textContent = (logs.acc * 100).toFixed(2);
                document.getElementById('epochProgress').style.width = `${((epoch + 1) / 15) * 100}%`;
            }

            displayResults(metrics) {
                // Show disease ranking
                const rankingDiv = document.getElementById('diseaseRanking');
                rankingDiv.innerHTML = '<h4>Disease Accuracy Ranking</h4>';
                
                const table = document.createElement('table');
                table.innerHTML = `
                    <thead>
                        <tr><th>Disease</th><th>Accuracy</th><th>Samples</th></tr>
                    </thead>
                    <tbody>
                        ${metrics.diseaseRanking.map(item => `
                            <tr>
                                <td>${item.disease}</td>
                                <td>${(item.accuracy * 100).toFixed(1)}%</td>
                                <td>${item.samples}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;
                rankingDiv.appendChild(table);
            }

            showMessage(message, type = 'info') {
                const messageDiv = document.getElementById('message');
                messageDiv.textContent = message;
                messageDiv.className = `message ${type}`;
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            new ChickenDiseaseApp();
        });
    </script>
</body>
</html>
